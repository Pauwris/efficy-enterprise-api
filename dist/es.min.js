class t{#t="CrmEnv";#e=!("undefined"==typeof process||!process?.versions?.node);#s="object"==typeof window;constructor(t){"object"==typeof t&&this.setEnv(t),this.#s&&this.setEnv({url:window.location.origin}),this.#i()}setEnv(t){this.url=t.url||"",this.customer=t.customer||"",this.logOff="boolean"==typeof t.logOff&&t.logOff,this.apiKey=t.apiKey||"",this.user=t.user||"",this.pwd=t.pwd||"",this.cookies=t.cookies||[],this.url=this.url.replace(/\/$/,""),this.#i()}#i(){if(!this.#r(this.url))throw new TypeError(`${this.#t}.validate::url is not valid`);if(!this.#s&&!this.user&&!this.apiKey)throw new TypeError(`${this.#t}.validate::apiKey or user are not specified`)}get isNode(){return this.#e}get isEfficy(){return this.#s}get cookieHeader(){if(Array.isArray(this.cookies)){return this.cookies.filter((t=>new Date<new Date(t.expires))).map((t=>[t.name,t.value].join("="))).join("; ")}}get sessionId(){return Array.isArray(this.cookies)&&this.cookies.length>0?this.cookies[0].value:""}get shortSessionId(){return this.sessionId.split("-")[0]}#r(t){let e;try{e=new URL(t)}catch(t){return!1}return"http:"===e.protocol||"https:"===e.protocol}}var e={decodeValues:!0,map:!1,silent:!1};function s(t){return"string"==typeof t&&!!t.trim()}function i(t,i){var r=t.split(";").filter(s),a=r.shift().split("="),n=a.shift(),o=a.join("=");i=i?Object.assign({},e,i):e;try{o=i.decodeValues?decodeURIComponent(o):o}catch(t){console.error("set-cookie-parser encountered an error while decoding a cookie with value '"+o+"'. Set options.decodeValues to false to disable this feature.",t)}var c={name:n,value:o};return r.forEach((function(t){var e=t.split("="),s=e.shift().trimLeft().toLowerCase(),i=e.join("=");"expires"===s?c.expires=new Date(i):"max-age"===s?c.maxAge=parseInt(i,10):"secure"===s?c.secure=!0:"httponly"===s?c.httpOnly=!0:"samesite"===s?c.sameSite=i:c[s]=i})),c}function r(t,e){if("object"!=typeof e)throw new TypeError("findDeep::searchObject is not an object");if(Array.isArray(t))for(const s of t){const t=r(s,e);if(t)return t}else if("object"==typeof t){let s=!0;if(Object.keys(e).filter((i=>{t.hasOwnProperty(i)&&t[i]===e[i]||(s=!1)})),s)return t;for(const s of Object.keys(t))if("object"==typeof t[s]){const i=r(t[s],e);if(null!=i)return i}return null}}class a{d_request=new Date;d_response;elapsed_ms;sessionId;requestId;method="";statusCode=0;statusText="";requestUrl="";exception;#a;#n;#o;constructor(t,e,s){this.requestId=t,this.#o=e,this.threadId=s}get requestObject(){return this.#a}get responseObject(){return this.#n}countFuncItems(t){return Array.isArray(t)&&t.length>0&&Array.isArray(t[0]["@func"])?t[0]["@func"].length:0}setRequest(t,e,s){this.requestUrl=t,this.method=e,this.#a=s}setResponse(t,e){this.d_response=new Date,this.statusCode=parseInt(t.status,10),this.statusText=t.statusText,this.elapsed_ms=this.d_response.getTime()-this.d_request.getTime(),this.#n=this.#c(e)}log(){const t=`${this.threadId},${this.method}-${[this.requestId]}`;"function"==typeof this.#o&&(this.statusCode>0?this.#o(`<${t},${this.statusCode} ${this.statusText} (${this.elapsed_ms} ms)${this.sessionId?`,${this.sessionId}`:","}${this.exception?",EXCEPTION_RPC":""}`,this):this.#o(`>${t},FUNCS-${this.countFuncItems(this.#a)}`,this))}#c(t){const e=JSON.parse(JSON.stringify(t)),s=r(e,{encodingkind:"MIME64"});return s&&"string"==typeof s["@data"]&&s["@data"].length>100&&(s["@data"]="**CLEANED**"),e}}const n=t=>t!==Object(t),o={fieldsObj(t){const e={};return!t||"object"!=typeof t||Array.isArray(t)||Object.keys(t).forEach((s=>{n(t[s])&&(e[s]=t[s])})),e},toFloatKey:t=>parseFloat(t)||0,numberProperties:(t,e)=>(e.forEach((e=>{t[e]&&!1===isNaN(parseFloat(t[e]))&&(t[e]=parseFloat(t[e]))})),t)},c={isFieldValue(t){if(!1===n(t))throw new TypeError("ParseHard.isFieldValue::argument 'value' is not a primitive value")}};class h{#h;requestObject;responseObject;id;constructor(t){this.#h=t,this.id="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})),this.requestObject={},this.responseObject={}}get api(){return this.#h}afterExecute(){this.responseObject=o.numberProperties(this.responseObject,["edithandle","key"])}}class u{name;type;#u;#l;constructor(t,e,s,i){if(!["main","master","detail","category"].includes(t))throw new TypeError("DataSet.constructor::invalid type");if(["detail","category"].includes(t)&&!e)throw new TypeError("DataSet.constructor::name must be specified");this.type=t,this.name=e,this.filter=s&&"string"==typeof s?s:void 0,this.includeBlobContent="boolean"==typeof i&&i}get items(){return this.#u}get item(){return this.#l}setItems(t){if(t){if(!Array.isArray(t))throw new TypeError("DataSet.items::value is not an Array");this.#u=t,this.#u.length>0&&(this.#l=this.#u[0])}}get func(){const t={};return t["@name"]=this.type,this.name&&(t[this.type]=this.name),this.filter&&(t.filter=this.filter),this.includeblobcontent&&(t.includeBlobContent=!0),t}}class l extends h{#u;#l;constructor(t){super(t),this.api.registerObject(this)}dataSetName;afterExecute(){super.afterExecute();const t=new u("main");t.setItems(this.api.findDataSetArray(this.responseObject,this.dataSetName)),this.#u=t.items,this.#l=t.item}get items(){return this.#u}get item(){return this.#l}}class d extends h{#d;#y;constructor(t){super(t),this.resetState()}getMasterDataSet(){return this.#d=new u("master")}getCategoryDataSet(t){if("string"!=typeof t)throw new TypeError("DataSetList.getCategoryDataSet::categoryName is not a string");return this.#y.category[t]=new u("category",t)}getDetailDataSet(t,e,s){if("string"!=typeof t)throw new TypeError("DataSetList.getDetailDataSet::detail is not a string");if(e&&"string"!=typeof e)throw new TypeError("DataSetList.getDetailDataSet::filter is not a string");if(null!=s&&"boolean"!=typeof s)throw new TypeError("DataSetList.getDetailDataSet::includeBlobContent is not a boolean");return this.#y.detail[t]=new u("detail",t,e,s)}resetState(){this.#d=null,this.#y={category:{},detail:{}}}get funcs(){const t=[];return this.#d&&t.push(this.#d.func),Object.keys(this.#y).forEach((e=>{const s=this.#y[e];Object.keys(s).forEach((e=>{const i=s[e];t.push(i.func)}))})),t}afterExecute(){this.#d&&this.#p(this.#d),Object.keys(this.#y).forEach((t=>{const e=this.#y[t];Object.keys(e).forEach((t=>{this.#p(e[t])}))}))}setResponseObject(t){this.responseObject=t}setData(t){t.data={},t.data.master=this.#d?.item,Object.keys(this.#y).forEach((e=>{const s=this.#y[e];t.data[e]={},Object.keys(s).forEach((i=>{t.data[e][i]="category"===e?s[i].item:s[i].items}))}))}#p(t){if(t instanceof u==!1)throw new TypeError("DataSetList.setDsoItems::dso is not an DataSet type");const e=this.api.findFuncArray2(this.responseObject,t.type,t.type,t.name);t.setItems(e)}}class y{key;#m;constructor(t){this.key=t}setStream(t){this.#m=t}get base64Stream(){return this.#m}get func(){const t={"@name":"attachment"};return t.key=this.key,t}}class p extends h{#f;constructor(t){super(t),this.resetState()}getAttachment(t,e=0){if("number"!=typeof t)throw new TypeError("AttachmentList.getAttachment::k_file is not a number");if("number"!=typeof e)throw new TypeError("AttachmentList.getAttachment::version is not a number");const s=new y(`${t}_${e}`);return this.#f.push(s),s}resetState(){this.#f=[]}get funcs(){return this.#f.map((t=>t.func))}setResponseObject(t){this.responseObject=t}afterExecute(){this.#f.forEach((t=>{const e=this.api.findAttachment(this.responseObject,t.key);e&&t.setStream(e["#result"])}))}}class m extends h{entity;key;edithandle;data;commit;closecontext;inserted;#g;#b;#w;#E;#j;#O;#x;constructor(t,e,s,i){super(t),this.entity=e,this.key=o.toFloatKey(s),this.#j=new d(t),this.#O=new p(t),this.inserted=0===this.key,this.edithandle=i,this.#D(),this.#S()}#D(){this.commit=null,this.closecontext=null,this.inserted=null,this.#g={},this.#b={},this.#w={},this.#E=[],this.#j.resetState(),this.#O.resetState(),this.#x=!1}#S(){this.#x||(this.api.registerObject(this),this.#x=!0)}getMasterDataSet(){return this.#S(),this.#j.getMasterDataSet()}getCategoryDataSet(t){return this.#S(),this.#j.getCategoryDataSet(t)}getDetailDataSet(t,e="",s=!1){return this.#S(),this.#j.getDetailDataSet(t,e,s)}getAttachment(t,e){return this.#S(),this.#O.getAttachment(t,e)}updateField(t,e){c.isFieldValue(e),this.#g[t]=e,this.#S()}updateFields(t){Object.assign(this.#g,o.fieldsObj(t)),this.#S()}updateCategoryField(t,e,s){if("string"!=typeof t)throw new TypeError("EditObject.updateCategoryField::categoryName is not a string");c.isFieldValue(s),this.#b[t]=this.#b[t]||{},this.#b[t][e]=s,this.#S()}updateCategoryFields(t,e){if("string"!=typeof t)throw new TypeError("EditObject.updateCategoryFields::categoryName is not a string");this.#b[t]=this.#b[t]||{},Object.assign(this.#b[t],o.fieldsObj(e)),this.#S()}insertDetail(t,e,s=!1,i=!1){if("string"!=typeof t)throw new TypeError("EditObject.insertDetail::detail is not a string");const r={"@name":"insertDetail",detail:t,detailkey:e};"boolean"==typeof s&&s&&(r.maincomp=s),"boolean"==typeof i&&i&&(r.retrieveName=i),this.#E.push(r),this.#S()}updateDetail(t,e,s){if("string"!=typeof t)throw new TypeError("EditObject.updateDetail::detail is not a string");this.#E.push({"@name":"updateDetail",detail:t,detailkey:e,"@data":o.fieldsObj(s)}),this.#S()}deleteDetail(t,e){if("string"!=typeof t)throw new TypeError("EditObject.deleteDetail::detail is not a string");this.#E.push({"@name":"deleteDetail",detail:t,detailkey:e}),this.#S()}clearDetail(t){if("string"!=typeof t)throw new TypeError("EditObject.clearDetail::detail is not a string");this.#E.push({"@name":"clearDetail",detail:t}),this.#S()}activateCategory(t){if("string"!=typeof t)throw new TypeError("EditObject.activateCategory::categoryName is not a string");this.#E.push({"@name":"activateCategory",category:t}),this.#S()}setReference(t){if("number"!=typeof t)throw new TypeError("EditObject.setReference::id is not a number");this.#E.push({"@name":"reference",id:o.toFloatKey(t)}),this.#S()}setUsers(t,e=!1){if(!Array.isArray(t))throw new TypeError("EditObject.setUsers::users is not an Array");const s={"@name":"setusers",users:t};"boolean"==typeof e&&(s.clear=e),this.#E.push(s),this.#S()}setUserSecurity(t,e){if("number"!=typeof t)throw new TypeError("EditObject.setUserSecurity::account is not a number");if("number"!=typeof e)throw new TypeError("EditObject.setUserSecurity::securityValue is not a number");this.#E.push({"@name":"setusersecurity",user:t,security:e}),this.#S()}insertAttachment(t,e){if("number"!=typeof t)throw new TypeError("EditObject.insertAttachment::attachedFileType is not a number");if("string"!=typeof e)throw new TypeError("EditObject.insertAttachment::path is not a string");this.#E.push({"@name":"insertAttachment",type:t,path:e}),this.#S()}updateAttachment(t=0,e){if("number"!=typeof t)throw new TypeError("EditObject.updateAttachment::key is not a number");if("string"!=typeof e)throw new TypeError("EditObject.updateAttachment::base64String is not a string");this.#E.push({"@name":"updateAttachment",key:t,encodingkind:"MIME64","@data":e}),this.#S()}copyFromExisting(t,e=0,s=999){if("number"!=typeof t)throw new TypeError("EditObject.copyFromExisting::key is not a number");if("number"!=typeof e)throw new TypeError("EditObject.copyFromExisting::minTableView is not a number");if("number"!=typeof s)throw new TypeError("EditObject.copyFromExisting::maxTableView is not a number");this.#E.push({"@name":"copyFromExisting",key:t,mintableview:e,maxtableview:s}),this.#S()}commitChanges(){this.commit=!0,this.#S()}closeContext(){this.closecontext=!0,this.#S()}closingCommit(){this.commit=!0,this.closecontext=!0,this.#S()}asJsonRpc(){const t={"#id":this.id,"@name":"edit","@func":[]};return["entity","key","edithandle","commit","closecontext"].forEach((e=>{null!=this[e]&&(t[e]=this[e])})),"object"==typeof this.#w&&Object.keys(this.#w).length>0&&Object.keys(this.#w).forEach((e=>{t["@func"].push({"@name":"detail",detail:e})})),t["@func"].push(...this.#E),"object"==typeof this.#b&&Object.keys(this.#b).length>0&&Object.keys(this.#b).forEach((e=>{t["@func"].push({"@name":"update",category:e,"@data":this.#b[e]})})),t["@func"].push(...this.#j.funcs),t["@func"].push(...this.#O.funcs),"object"==typeof this.#g&&Object.keys(this.#g).length>0&&t["@func"].push({"@name":"update","@data":this.#g}),t}afterExecute(){super.afterExecute(),["entity","key","edithandle","commit","closecontext"].forEach((t=>{this[t]=this.responseObject[t]})),this.#j.setResponseObject(this.responseObject),this.#j.afterExecute(),this.#j.setData(this),this.#O.setResponseObject(this.responseObject),this.#O.afterExecute(),this.#D()}}class f extends h{constructor(t){super(t)}async getFiles(t,e,s){await this.api.executeBatch();const i=t.getDetailDataSet("file",e,s);if(await this.api.executeBatch(),!Array.isArray(i.items)||0===i.items.length)return[];return i.items.sort(((t,e)=>e.K_SORT-t.K_SORT))}async deleteFiles(t,e){(await this.getFiles(t,e,!1)).forEach((e=>{t.deleteDetail("file",e.K_FILE+"_"+e.VERSION)})),await this.api.executeBatch()}async cleanupFiles(t,e,s=7){(await this.getFiles(t,e,!1)).filter(((t,e)=>e>=s)).forEach((e=>{t.deleteDetail("file",e.K_FILE+"_"+e.VERSION)})),await this.api.executeBatch()}}class g extends h{entity;key;consulthandle;data;closecontext;#E;#j;#x;constructor(t,e,s,i){super(t),this.entity=e,this.key=o.toFloatKey(s),this.consulthandle=i,this.#j=new d(t),this.#D(),this.#S()}#D(){this.closecontext=null,this.#E=[],this.#j.resetState(),this.#x=!1}#S(){this.#x||(this.api.registerObject(this),this.#x=!0)}getMasterDataSet(){return this.#S(),this.#j.getMasterDataSet()}getCategoryDataSet(t){return this.#S(),this.#j.getCategoryDataSet(t)}getDetailDataSet(t,e="",s=!1){return this.#S(),this.#j.getDetailDataSet(t)}closeContext(){this.closecontext=!0,this.#S()}asJsonRpc(){const t={"#id":this.id,"@name":"consult","@func":[]};return["entity","key","consulthandle","closecontext"].forEach((e=>{null!=this[e]&&(t[e]=this[e])})),t["@func"].push(...this.#j.funcs),t["@func"].push(...this.#E),t}afterExecute(){super.afterExecute(),["entity","key","consulthandle","closecontext"].forEach((t=>{this[t]=this.responseObject[t]})),this.#j.setResponseObject(this.responseObject),this.#j.afterExecute(),this.#j.setData(this),this.#D()}}class b extends l{entity;method;value;own;contains;opened;constructor(t,e,s,i,r,a,n){super(t),this.entity=e,this.method=s,this.value=i,this.own=r,this.contains=a,this.opened=n}asJsonRpc(){const t={"#id":this.id,"@name":"search","@func":[{"@name":"master",tableview:0}]};return["entity","method","value","method","contains","own"].forEach((e=>{null!=this[e]&&(t[e]=this[e])})),t}}class w extends l{constructor(t,e,s){super(t),this.dataSetName="collection",this.entity=e,this.detail=s}asJsonRpc(){const t={"@name":"getcategorycollection"};this.entity&&(t.entity=this.entity),this.detail&&(t.detail=this.detail);return{"#id":this.id,"@name":"api","@func":[t]}}}class E extends h{constructor(t,e,s){super(t),this.entity=e,this.keys=Array.isArray(s)?s:[s],this.api.registerObject(this)}asJsonRpc(){const t={"@name":"delete",entity:this.entity,keys:this.keys.join(";")};return{"#id":this.id,"@name":"api","@func":[t]}}}class j extends l{constructor(t,e,s,i,r=[],a=!1,n=0){super(t),this.key=e,this.master=s,this.detail=i,this.queryParams=r,this.loadBlobs="boolean"==typeof a&&a,this.recordCount=n}asJsonRpc(){const t={"@name":"query",loadBlobs:this.loadBlobs,recordCount:this.recordCount};"number"==typeof this.key&&(t.key=this.key),"number"==typeof this.master&&(t.master=this.master),"number"==typeof this.detail&&(t.detail=this.detail),Array.isArray(this.queryParams)&&(t.queryparams=this.queryParams.join("|"));return this.requestObject={"#id":this.id,"@name":"api","@func":[t]}}}class O extends l{constructor(t,e,s=[],i=!1,r=0){super(t),this.sql=e,this.queryParams=s,this.loadBlobs="boolean"==typeof i&&i,this.recordCount=r}asJsonRpc(){const t={"@name":"executesqlquery",sql:this.sql,loadBlobs:this.loadBlobs,recordCount:this.recordCount};Array.isArray(this.queryParams)&&(t.queryparams=this.queryParams.join("\n"));return this.requestObject={"#id":this.id,"@name":"api","@func":[t]}}}class x extends l{constructor(t,e,s,i,r){super(t),this.entity=e,this.whereFields=s,this.whereValues=i,this.orderByExpression=r}asJsonRpc(){const t={"@name":"consultmanyex",entity:this.entity,findfield:this.whereFields.join(";"),keys:this.whereValues.join(";"),orderbyfield:this.orderByExpression,separator:";"};return this.requestObject={"#id":this.id,"@name":"api","@func":[t]}}}class D extends l{constructor(t,e,s=[]){if(super(t),s&&!Array.isArray(s))throw TypeError("RecentListEx.constructor::extraFields is not an array");this.entity=e,this.extraFields=s}asJsonRpc(){const t={"@name":"recentlistex",entity:this.entity,extrafields:this.extraFields.join(",")};return this.requestObject={"#id":this.id,"@name":"api","@func":[t]}}}class S extends l{constructor(t,e){super(t),this.entity=e}asJsonRpc(){const t={"@name":"favoritelist",entity:this.entity};return this.requestObject={"#id":this.id,"@name":"api","@func":[t]}}}class A extends l{constructor(t){super(t)}asJsonRpc(){return this.requestObject={"#id":this.id,"@name":"api","@func":[{"@name":"userlist"}]}}}class F extends l{constructor(t,e=[],s=""){super(t),this.recipients=e,this.phoneNumber=s}asJsonRpc(){var t;if(Array.isArray(this.recipients)&&this.recipients.length>0?t={"@name":"contactidsfromemailaddresses",recipients:this.recipients.join(";")}:this.phoneNumber&&(t={"@name":"searchcontactsbyphone",phonenumber:this.phoneNumber}),!t)throw Error("ContactsList.asJsonRpc::unable to define the operation @name");return this.requestObject={"#id":this.id,"@name":"api","@func":[t]}}}class v extends h{map;constructor(t){super(t),this.api.registerObject(this)}afterExecute(){super.afterExecute(),this.items=this.api.findListArray(this.responseObject),this.map=new Map(this.items.map((t=>[t.split("=")[0],t.split("=")[1]])))}}class k extends v{constructor(t){super(t),this.api.registerObject(this)}asJsonRpc(){return this.requestObject={"#id":this.id,"@name":"api","@func":[{"@name":"systemsettings"}]}}}class C extends h{result;operationName;constructor(t){super(t),this.api.registerObject(this)}afterExecute(){super.afterExecute(),this.result=this.api.findFunc(this.responseObject,this.operationName)?.["#result"]}}class T extends C{module;name;asString;constructor(t,e,s,i=!0){super(t),this.operationName="getsetting",this.module=e,this.name=s,this.asString="boolean"==typeof i?i:i=!0,this.api.registerObject(this)}asJsonRpc(){const t={"@name":this.operationName,module:this.module,name:this.name,asstring:this.asString};return this.requestObject={"#id":this.id,"@name":"api","@func":[t]}}}class L extends class{#t="RemoteAPI";crmEnv;remoteObjects;logFunction;requestCounter=0;threadId=1;lastResponseObject;constructor(e=new t,s,i){if(e&&"object"!=typeof e)throw new TypeError(`${this.#t}.constructor::crmEnv is not an Object`);if(s&&"function"!=typeof s)throw new TypeError(`${this.#t}.constructor::logFunction is not a function`);i&&(this.threadId=i),this.crmEnv=e,this.remoteObjects=[],this.logFunction=s,this.#A()}#A(){try{this.crmEnv.apiKey?this.#F.headers["X-Efficy-ApiKey"]=this.crmEnv.apiKey:this.crmEnv.user&&this.crmEnv.pwd&&(this.#F.headers["X-Efficy-User"]=this.crmEnv.user,this.#F.headers["X-Efficy-Pwd"]=this.crmEnv.pwd),this.crmEnv.logOff&&(this.#F.headers["X-Efficy-Logoff"]=!0)}catch(t){throw Error(`${this.#t}.readEnv::${t.message}`)}}#F={method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"}};async executeBatch(){const t=[],e=[];try{t.push(...this.remoteObjects.map((t=>t.asJsonRpc())))}catch(r){throw Error(`${this.#t}.executeBatch::asJsonRpc\n${r.message}`)}if(!t.length)return;try{const s=await this.post(t);if(!Array.isArray(s))throw new TypeError(`${this.#t}.executeBatch::responseObject is not an Array`);e.push(...s),this.lastResponseObject=e}catch(r){throw Error(`${this.#t}.executeBatch::${r.message}`)}const s=this.remoteObjects;for(var i=s.length;i--;){const t=s[i],r=e.find((e=>e["#id"]===t.id));if(!r)throw Error(`${this.#t}.executeBatch::cannot find response for queued operation [${i}/${s.length}]`);Object.assign(t.responseObject,r),t.afterExecute(),s.splice(i,1)}const r=this.getRpcException(e);if(r)throw Error(`${r["#error"].errorcode} - ${r["#error"].errorstring}`)}logoff(){if(this.crmEnv.isEfficy)throw Error(`${this.#t}.logoff::method disable for this environment`);this.crmEnv.logOff=!0,this.#A()}registerObject(t){this.remoteObjects.push(t)}async post(t){var r,n,o;if("function"!=typeof fetch){var c=await import("node-fetch");c&&(global.fetch=c.default)}try{const c=Object.assign(this.#F,{body:JSON.stringify(t)}),h=`${this.crmEnv.url}/crm/json${this.crmEnv.customer?"?customer="+encodeURIComponent(this.crmEnv.customer):""}`,u=new a(this.requestCounter++,this.logFunction,this.threadId);u.setRequest(h,c.method,t),this.crmEnv.cookieHeader&&(c.headers.Cookie=this.crmEnv.cookieHeader,u.sessionId=this.crmEnv.shortSessionId),u.log(),r=await fetch(h,c);try{n=await r.text(),o=JSON.parse(n||"[]")}catch(t){throw Error(`invalid JSON response from resource '${h}'`)}if(u.setResponse(r,o),u.exception=this.getRpcException(o),!this.crmEnv.isEfficy){const t=function(t,r){if(r=r?Object.assign({},e,r):e,!t)return r.map?{}:[];if(t.headers&&t.headers["set-cookie"])t=t.headers["set-cookie"];else if(t.headers){var a=t.headers[Object.keys(t.headers).find((function(t){return"set-cookie"===t.toLowerCase()}))];a||!t.headers.cookie||r.silent||console.warn("Warning: set-cookie-parser appears to have been called on a request object. It is designed to parse Set-Cookie headers from responses, not Cookie headers from requests. Set the option {silent: true} to suppress this warning."),t=a}if(Array.isArray(t)||(t=[t]),(r=r?Object.assign({},e,r):e).map)return t.filter(s).reduce((function(t,e){var s=i(e,r);return t[s.name]=s,t}),{});return t.filter(s).map((function(t){return i(t,r)}))}(r.headers.raw()["set-cookie"]);t.length>0&&(this.crmEnv.cookies=t,this.sessionId=this.crmEnv.shortSessionId)}if(u.log(),!0===o.error)throw Error(`/json: ${o.code} - ${o.message}`);return o}catch(t){throw Error(`${this.#t}.post::${t.message}`)}}findDataSetArray(t,e="dataset"){if("object"!=typeof t)return;const s=r(t,{"#class":e});return s&&Array.isArray(s["#data"])?s["#data"]:void 0}findListArray(t,e="stringlist"){return this.findDataSetArray(t,e)}findAttachment(t,e){if("object"==typeof t)return r(t,{"@name":"attachment",key:e})}findFunc(t,e){if("object"==typeof t&&Array.isArray(t["@func"]))return t["@func"].find((t=>t["@name"]===e))}findFunc2(t,e,s,i){if("object"==typeof t&&Array.isArray(t["@func"]))return t["@func"].find((t=>t["@name"]===e&&t[s]===i))}findFuncArray(t,e){var s=this.findDataSetArray(this.findFunc(t,e));return Array.isArray(s)?s:null}findFuncArray2(t,e,s,i){var r=this.findDataSetArray(this.findFunc2(t,e,s,i));return Array.isArray(r)?r:null}findFuncCategoryArray(t,e){var s=this.findDataSetArray(this.findFunc2(t,"category","category",e));return Array.isArray(s)?s:null}findFuncDetailArray(t,e){var s=this.findDataSetArray(this.findFunc2(t,"detail","detail",e));return Array.isArray(s)?s:null}getRpcException(t){return t.find((t=>"exception"===t["@name"]))}}{constructor(t,e,s){super(t,e,s)}async executeBatch(){return super.executeBatch()}logoff(){return super.logoff()}openConsultContext(t,e){return new g(this,t,e)}getConsultObject(t,e){return new g(this,e,0,t)}openEditObject(t,e=0){return new m(this,t,e)}getEditObject(t){return new m(this,"",0,t)}search(t,e,s,i=!1,r=!0,a=!0){return new b(this,t,e,s,i,r,a)}searchContactsByEmail(t){if(!Array.isArray(t)||t.length<1)throw TypeError("recipients is not a array with at least one item");return new F(this,t)}searchContactsByPhone(t){return new F(this,null,t)}executeDatabaseQuery(t,e,s=!1,i=0){return new j(this,t,null,null,e,s,i)}executeSystemQuery(t,e,s,i=!1,r=0){return new j(this,null,t,e,s,i,r)}executeSqlQuery(t,e,s=!1,i=0){return new O(this,t,e,s,i)}consultManyEx(t,e,s,i){return new x(this,t,e,s,i)}consultRecent(t,e=[]){return new D(this,t,e)}consultFavorites(t){return new S(this,t)}getCategoryCollection(t){return new w(this,t,"")}getUserList(){return new A(this)}getSystemSettings(){return new k(this)}getSetting(t,e,s=!0){return new T(this,t,e,s)}deleteEntity(t,e){!e||Array.isArray(e)&&0===e.length||new E(this,t,e)}get ws(){return new f(this)}constants={account_kind:{user:0,group:1,resource:2,team:3},file_type:{embedded:1,linked:2,remote:4,large:5}}}export{t as CrmEnv,L as CrmRpc};
